<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>フラッシュ暗算 v1</title>
    <link rel="icon" href="./images/favicon.ico">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
    <style>
        body {
            background-color: black;
        }
        h1 {
            font-size: 2.2rem;
            font-weight: bold;
            border-bottom: solid 2px white;
            padding-bottom: 10px;
        }
        h2 {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
            /* border-bottom: solid 2px white; */
            padding-bottom: 10px;
            text-align: right;
            padding-right: 30px;
        }
        div#dispNumber {
            font-size: 12rem;
            text-align: center;
            color: white;
            font-weight: bold;
        }
        button#start {
            font-size: 2.2rem;
        }
        div#result {
            color: #46b054;
            font-size: 12rem;
            font-weight: bold;
            opacity: 1;
            transition: all 3s ease-in-out;
        }
        .grow {
            font-size: 15rem !important;
        }

        .fade-out {
            opacity: 0 !important;
        }
    </style>
</head>
  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <img src="./images/navbar-brand.png">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">レベル </a>
                        <ul class="dropdown-menu" id="levels">
                            <li>
                                <p class="dropdown-item" data-value="1">1</p>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <p class="dropdown-item" data-value="2">2</p>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <p class="dropdown-item" data-value="3">3</p>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <p class="dropdown-item" data-value="4">4</p>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <p class="dropdown-item" data-value="5">5</p>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <p class="dropdown-item" data-value="6">6</p>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <p class="dropdown-item" data-value="7">7</p>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <p class="dropdown-item" data-value="8">8</p>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <p class="dropdown-item" data-value="9">9</p>
                            </li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li>
                                <p class="dropdown-item" data-value="10">10</p>
                            </li>
                        </ul>
                    </li>
                    <!-- <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    はやさ
                    </a>
                    <ul class="dropdown-menu">
                    <li><p class="dropdown-item">すごくおそい</p></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><p class="dropdown-item">おそい</p></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><p class="dropdown-item">ふつう</p></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><p class="dropdown-item">はやい</p></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><p class="dropdown-item">すごくはやい</p></li>
                    </ul>
                    </li> -->
                                    <!-- <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    かいすう
                    </a>
                    <ul class="dropdown-menu">
                    <li><p class="dropdown-item">すごくすくない</p></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><p class="dropdown-item">すくない</p></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><p class="dropdown-item">ふつう</p></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><p class="dropdown-item">すこしおおい</p></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><p class="dropdown-item">おおい</p></li>
                    </ul>
                    </li> -->
                </ul>
            </div>
        </div>
    </nav>
    <div class="container">
        <div class="row mb-3">
            <h1 class="col-sm-12 text-center text-info mt-5">そろばんあんざんそふと</h1>
        </div>
        <div class="row mb-3">
            <h2 class="col-sm-12 mt-2">かのんへ パパより</h2>
        </div>
        <div class="row pb-5">
            <button class="offset-sm-2 col-sm-8 btn btn-danger mt-2" id="start">すたーと（レベル: 1）</button>
        </div>
        <div class="row">
            <div class="col-sm-12" id="dispNumber"></div>
        </div>
        <div class="row">
            <button class="offset-sm-3 col-sm-6 btn btn-success fade-out" id="reset">やりなおし</button>
        </div>
        <div class="row pb-5 pt-3">
            <div class="col-sm-12 text-center" id="result"></div>
        </div>
        <div class="row d-flex justify-content-center align-items-center h-100 mb-3 fade-out" id="input">
            <div class="col-4 h-100 text-center bg-white border" id="inputNum">　</div>
            <button class="offset-1 col-4 h-100 btn btn-danger" id="challenge">こたえる</button>
        </div>
        <div class="row fade-out" id="calc">
            <div class="row d-flex justify-content-center">
                <button class="col-2 border btn btn-success text-white num" value="0">0</button> 
                <button class="col-2 border btn btn-success text-white num" value="1">1</button> 
                <button class="col-2 border btn btn-success text-white num" value="2">2</button> 
                <button class="col-2 border btn btn-success text-white num" value="3">3</button>
                <button class="col-2 border btn btn-success text-white num" value="4">4</button> 
            </div>
            <div class="row d-flex justify-content-center mt-1">
                <button class="col-2 border btn btn-success text-white num" value="5">5</button> 
                <button class="col-2 border btn btn-success text-white num" value="6">6</button> 
                <button class="col-2 border btn btn-success text-white num" value="7">7</button>
                <button class="col-2 border btn btn-success text-white num" value="8">8</button> 
                <button class="col-2 border btn btn-success text-white num" value="9">9</button> 
            </div>
        </div>
    </div>
    <script>

        window.onload = function(){

            // レベル定義
            const LEVELS = {
                '1': {
                        maxCount: 4,
                        maxNum: 9,
                        minNum: 1,
                        interval: 3000
                },
                2: {
                        maxCount: 8,
                        maxNum: 9,
                        minNum: 1,
                        interval: 3000
                },
                3: {
                        maxCount: 8,
                        maxNum: 9,
                        minNum: 1,
                        interval: 3000
                },
                4: {
                        maxCount: 10,
                        maxNum: 15,
                        minNum: 1,
                        interval: 3000
                },
                5: {
                        maxCount: 10,
                        maxNum: 15,
                        minNum: 1,
                        interval: 2000
                },
                6: {
                        maxCount: 15,
                        maxNum: 15,
                        minNum: 1,
                        interval: 2000
                },
                7: {
                        maxCount: 15,
                        maxNum: 20,
                        minNum: 1,
                        interval: 2000
                },
                8: {
                        maxCount: 15,
                        maxNum: 50,
                        minNum: 1,
                        interval: 2000
                },
                9: {
                        maxCount: 17,
                        maxNum: 70,
                        minNum: 1,
                        interval: 400
                },
                10: {
                        maxCount: 20,
                        maxNum: 99,
                        minNum: 1,
                        interval: 200
                },
            };

            // 各種定数、変数
            let currentLevel = '1';

            let MAXCOUNT = LEVELS[currentLevel].maxCount; // 設問数
            let MAXNUM = LEVELS[currentLevel].maxNum; // 1回に表示する数字の最大値
            let MINNUM = LEVELS[currentLevel].minNum; // 1回に表示する数字の最小値
            let INTERVAL = LEVELS[currentLevel].interval; // 数字表示間の秒数（ms） 
            
            const DELAY = 3500; // 各種delay(ms)
            
            let count = 1; // 一時的なカウント数
            let total = 0; // 現在の正解の合計値

            // DOM オブジェクト定数
            const levels = document.querySelectorAll("#levels p.dropdown-item");
            const navbarCollapse = document.querySelector(".navbar-collapse");
            const startButton = document.getElementById('start');
            const resetButton = document.getElementById('reset');
            const dispNumber = document.getElementById('dispNumber');
            const result = document.getElementById('result');
            const inputNum = document.getElementById('inputNum');
            const input = document.getElementById('input');
            const calc = document.getElementById('calc');
            const challenge = document.getElementById('challenge');
            
            let previousNumber = null; // 前回表示さた数字
            let startTimer; // 数字表示アニメーション
            let stopTimer; // 結果表示アニメーション
            
            // DELAYの非同期処理用
            const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
            // const music = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            // 数字を表示する関数
            const showNumber = async () => {

                console.log('-- showNumber関数実行-- ');

                if(count == 1){
                    console.log('## =======================')
                }
                console.log('★ showNumber: ' + count + '回目 ★');
                let random;
                do {
                    const sign = Math.random() < 0.5 ? -1 : 1;
                    random = Math.floor(Math.random() * (MAXNUM - MINNUM + 1)) + MINNUM; 
                    if(sign === -1 && random !== 0 && count !== 0 && total >= random){
                        random *= -1;
                    }
                } while (random === previousNumber); // 前回と同じなら振り直す

                previousNumber = random; // 現在の値を保存

                console.log('　　乱数: ' + random);
                dispNumber.textContent = random;
                startButton.textContent = 'いま: ' + total;
                startButton.textContent = 'かのん、がんばれ！';
                total += random;
                if(count >= MAXCOUNT){
                    startButton.textContent = 'いくつになった？';
                    console.log('　　※ 最終合計値: ' + total);
                    clearInterval(startTimer);
                    const music = new Audio('./audios/plus.mp3');
                    music.currentTime = 0;
                    music.play();
                    await delay(INTERVAL);
                    dispNumber.textContent = '';
                    resetButton.classList.add('fade-out');
                    showResult();
                }else{
                    count++;
                    console.log('　　ここまでの合計値: ' + total);
                    const music = new Audio('./audios/plus.mp3');
                    music.currentTime = 0;
                    music.play();
                }     
            };
    
            // 最終結果を表示する関数
            const showResult = async() => {
                console.log('-- showResult関数実行-- ');

                input.classList.remove('fade-out');
                calc.classList.remove('fade-out');
                console.log('★ 最終結果（' + total + '）画面表示！');
    
            };

            // レベルを選択した時のイベント処理
            for(let i = 0; i < levels.length; i++){
                levels[i].addEventListener('click', (e) => {
                    let selectedLevelValue = e.target.dataset.value;
                    console.log('選択されたLevelは' + selectedLevelValue);
                    currentLevel = selectedLevelValue;
                    let selectedLevel = LEVELS[selectedLevelValue];
                    console.log(selectedLevel);
                    showStartButtonContent(selectedLevelValue)
                    // 各種変数の設定
                    MAXCOUNT = selectedLevel.maxCount; // 設問数
                    MAXNUM = selectedLevel.maxNum; // 1回に表示する数字の最大値
                    MINNUM = selectedLevel.minNum; // 1回に表示する数字の最小値
                    INTERVAL = selectedLevel.interval; // 数字表示間の秒数（ms） 

                    const bsCollapse = new bootstrap.Collapse(navbarCollapse, { toggle: true });
                });
            }

            // 開始ボタンを押した時のイベント処理
            startButton.addEventListener('click', async () => {
                input.classList.add('fade-out');
                calc.classList.add('fade-out');
                reset.classList.remove('fade-out');

                count = 1;
                total = 0;
                result.textContent = '';
                startButton.disabled = true;
                startButton.textContent = 'がんばろう！';
                result.textContent = '';
                result.classList.remove('grow');
                showNum = '　'
                inputNum.textContent = showNum;
                startTimer = setInterval(showNumber, INTERVAL);

                const music = new Audio('./audios/q.mp3');
                music.currentTime = 0;
                music.play();
            });

            // 計算機の各ボタンへのイベント定義
            let showNum = '';
            let clickCount = 0;
            const btnClick = () => {
                const buttons = document.getElementsByClassName('num');
                for (let i = 0; i < buttons.length; i++) {
                    buttons[i].addEventListener('click', (e) => {
                        let value = e.target.value;
                        showNum = showNum + Number(value);
                        inputNum.textContent = Number(showNum);                     
                        clickCount++;
                    });
                }
            }
            btnClick();

            // スタートボタンに現状のLevelを表示する関数
            const showStartButtonContent = (nowLevel) => {
                startButton.textContent = 'すたーと（レベル: ' + nowLevel + '）';
            }

            // 答えるボタンを押した時のイベント処理
            challenge.addEventListener('click', async () => {
                
                console.log('-- 答えるボタンを押した時-- ');

                input.classList.add('fade-out');
                calc.classList.add('fade-out');
                if(Number(showNum) == total){
                    result.textContent = '〇'
                    const music = new Audio('./audios/success.mp3');
                    music.currentTime = 0;
                    music.play();
                    console.log('正解');
                }else{
                    result.textContent = 'X';
                    const music = new Audio('./audios/fail.mp3');
                    music.currentTime = 0;
                    music.play();
                    console.log('不正解');
                }
                await delay(DELAY);
                startButton.disabled = false;
                showStartButtonContent(currentLevel);
                
            });

            // リセットボタンを押した時のイベント処理
            reset.addEventListener('click', () => {
                clearInterval(startTimer);
                reset.classList.add('fade-out');

                count = 1;
                total = 0;
                startButton.disabled = false;
                showStartButtonContent(currentLevel);
                dispNumber.textContent = '';
                
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>
  </body>
</html>